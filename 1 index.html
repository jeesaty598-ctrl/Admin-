<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Control Panel</title>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root {
            --bg-dark: #0d1117; --bg-primary: #161b22; --bg-secondary: #21262d;
            --border-color: #30363d; --text-primary: #c9d1d9; --text-secondary: #8b949e;
            --accent-blue: #58a6ff; --accent-green: #3fb950; --accent-red: #f85149;
            --accent-purple: #a371f7; --accent-yellow: #d29922;
            --sidebar-width: 240px;
        }
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

code
Code
download
content_copy
expand_less
html { scroll-behavior: smooth; }
    body { font-family: 'Roboto', sans-serif; background-color: var(--bg-dark); color: var(--text-primary); margin: 0; padding: 0; }
    
    .header {
        background-color: var(--bg-primary); border-bottom: 1px solid var(--border-color);
        padding: 10px 20px; display: flex; align-items: center;
        position: fixed; top: 0; left: 0; right: 0; z-index: 1001;
    }
    #menu-toggle { 
        cursor: pointer; padding: 10px; z-index: 1002;
    }
    #menu-toggle .bar {
        display: block; width: 25px; height: 3px; margin: 5px auto;
        background-color: var(--text-primary); transition: all 0.3s ease-in-out;
    }
    #menu-toggle.active .bar:nth-child(1) { transform: translateY(8px) rotate(45deg); }
    #menu-toggle.active .bar:nth-child(2) { opacity: 0; }
    #menu-toggle.active .bar:nth-child(3) { transform: translateY(-8px) rotate(-45deg); }

    .header h1 { font-size: 1.2em; margin: 0; margin-left: 15px; color: var(--accent-blue); }
    
    .sidebar {
        height: 100%; width: var(--sidebar-width); position: fixed; z-index: 1000;
        top: 0; left: calc(-1 * var(--sidebar-width)); background-color: var(--bg-primary);
        border-right: 1px solid var(--border-color); transition: left 0.3s ease-in-out;
        padding-top: 80px; 
    }
    .sidebar.open { left: 0; }
    .sidebar nav a {
        padding: 15px 20px; text-decoration: none; font-size: 1em;
        color: var(--text-secondary); display: flex; justify-content: space-between; align-items: center; 
        transition: background-color 0.2s, color 0.2s;
        border-left: 3px solid transparent; cursor: pointer;
    }
    .sidebar nav a:hover { background-color: var(--bg-secondary); color: var(--text-primary); border-left-color: var(--accent-blue); }
    
    #main-content {
        margin-top: 60px;
        padding: 20px;
    }
    .container { max-width: 900px; margin: auto; }

    .admin-section { display: none; }
    .admin-section.is-active { display: block; }
    
    .notification-badge {
        background-color: var(--accent-red); color: white;
        border-radius: 50%; padding: 1px 7px;
        font-size: 0.8em; font-weight: bold;
        display: none; /* Hidden by default */
    }

    .btn { padding: 10px 15px; border: none; border-radius: 6px; font-size: 1em; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn:disabled { background-color: var(--text-secondary) !important; cursor: not-allowed; }
    .btn-green { background-color: var(--accent-green) !important; color: white !important; }
    .btn-primary { background-color: var(--accent-blue) !important; color: white !important; }
    .btn-red { background-color: var(--accent-red) !important; color: white !important; }
    .btn-yellow { background-color: var(--accent-yellow) !important; color: white !important; }
    .input-group { margin-bottom: 15px; }
    .input-group label { display: block; margin-bottom: 5px; color: var(--text-secondary); font-size: 0.9em; }
    .input-group input, .input-group select { width: 100%; padding: 10px; font-size: 1em; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-primary); color: var(--text-primary); box-sizing: border-box; }
    .admin-panel { background-color: var(--bg-secondary); border-radius: 10px; padding: 20px; margin-bottom: 20px; border: 1px solid var(--border-color); }
    .admin-panel h3 { text-align: center; color: var(--accent-blue); margin-top: 0; }
    .admin-control { display: flex; gap: 10px; }
    .admin-control input, .admin-control select { flex-grow: 1; }
    .admin-status { margin-top: 10px; text-align: center; font-style: italic; color: var(--accent-yellow); font-size: 0.9em; height: 1em;}
    #auth-container { max-width: 380px; margin: 50px auto; padding: 25px; background-color: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 10px; }
    .auth-error { color: var(--accent-red); margin-bottom: 15px; font-size: 0.9em; text-align: center; height: 1.2em;}
    .auth-toggle { text-align: center; margin-top: 20px; font-size: 0.9em; }
    .auth-toggle a { color: var(--accent-blue); text-decoration: none; cursor: pointer; }
    .auth-toggle a:hover { text-decoration: underline; }
    .divider { text-align: center; color: var(--text-secondary); margin: 20px 0; font-weight: 500; border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 25px; }
    .table-container { max-height: 500px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 6px;}
    table { width: 100%; border-collapse: collapse; }
    table th, table td { padding: 12px 10px; text-align: left; border-bottom: 1px solid var(--border-color); }
    table th { background-color: var(--bg-primary); color: var(--accent-blue); position: sticky; top: 0; }
    table td { font-size: 0.9em; vertical-align: middle; word-break: break-all; }
    table tr:last-child td { border-bottom: none; }
    .action-btn { font-size: 0.8em; padding: 4px 8px; margin-right: 5px; }
    .status-blocked { color: var(--accent-red); font-weight: bold; }
    .status-active { color: var(--accent-green); font-weight: bold; }

    /* Dashboard Styles */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }
    .stat-card {
        background-color: var(--bg-primary); padding: 20px; border-radius: 8px;
        border: 1px solid var(--border-color); text-align: center;
    }
    .stat-card h4 { margin-top: 0; color: var(--text-secondary); font-size: 1em; font-weight: 500; }
    .stat-card p { font-size: 2em; font-weight: bold; color: var(--accent-blue); margin: 10px 0 0 0; }
    .stat-card p#pending-deposits-stat, .stat-card p#pending-withdrawals-stat { color: var(--accent-yellow); }
    
    /* Promotion Banner Styles */
    .promo-card {
        background-color: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .promo-card img {
        max-width: 100%;
        height: auto;
        border-radius: 6px;
        align-self: center;
        max-height: 150px;
    }
    .promo-card .info {
        font-size: 0.9em;
        word-break: break-all;
    }
    .promo-card .info strong {
        color: var(--text-secondary);
    }
    .promo-card .actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 10px;
    }
    .promo-card .edit-inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
</style>
</head>
<body>

code
Code
download
content_copy
expand_less
<div id="auth-container">
    <!-- Login & Sign-Up Boxes -->
    <div id="login-box"> <h2>Admin Login</h2> <p class="auth-error" id="login-error"></p> <div class="input-group"> <label for="login-email">Email</label> <input type="email" id="login-email" required> </div> <div class="input-group"> <label for="login-password">Password</label> <input type="password" id="login-password" required> </div> <button id="login-btn" class="btn btn-primary" style="width: 100%;">Login</button> <p class="auth-toggle">Don't have an account? <a id="show-signup">Sign Up</a></p> </div>
    <div id="signup-box" style="display: none;"> <h2>Admin Sign Up</h2> <p class="auth-error" id="signup-error"></p> <div class="input-group"> <label for="signup-email">Email</label> <input type="email" id="signup-email" required> </div> <div class="input-group"> <label for="signup-password">Password</label> <input type="password" id="signup-password" required> </div> <div class="input-group"> <label for="signup-confirm-password">Confirm Password</label> <input type="password" id="signup-confirm-password" required> </div> <button id="signup-btn" class="btn btn-primary" style="width: 100%;">Sign Up</button> <p class="auth-toggle">Already have an account? <a id="show-login">Login</a></p> </div>
</div>

<!-- Admin Dashboard Layout with Sidebar -->
<div id="admin-dashboard" style="display: none;">
    <header class="header">
        <div id="menu-toggle">
            <span class="bar"></span><span class="bar"></span><span class="bar"></span>
        </div>
        <h1>Admin Panel</h1>
    </header>

    <aside class="sidebar" id="sidebar">
        <nav>
            <a data-target="#dashboard-panel" class="sidebar-link">Dashboard</a>
            <a data-target="#deposit-requests-panel" class="sidebar-link">
                <span>Deposits</span>
                <span class="notification-badge" id="deposit-badge"></span>
            </a>
            <a data-target="#withdraw-requests-panel" class="sidebar-link">
                <span>Withdrawals</span>
                <span class="notification-badge" id="withdraw-badge"></span>
            </a>
            <a data-target="#user-management-panel" class="sidebar-link">User Management</a>
            <a data-target="#user-list-panel" class="sidebar-link">User List</a>
            <a data-target="#gift-code-panel" class="sidebar-link">Gift Codes</a>
            <a data-target="#game-controls-panel" class="sidebar-link">Game Controls</a>
            <a data-target="#promotion-panel" class="sidebar-link">Promotion Banner</a>
            <a id="logout-link-sidebar" class="sidebar-link" style="color: var(--accent-red);">Logout</a>
        </nav>
    </aside>

    <main id="main-content">
        <div class="container">
            <h2>Welcome, <span id="admin-email" style="font-size: 0.8em; color: var(--text-secondary);"></span></h2>
            
            <!-- Dashboard / Overview Panel -->
            <section id="dashboard-panel" class="admin-panel admin-section"></section>
            
            <!-- Deposit Requests Panel -->
            <section id="deposit-requests-panel" class="admin-panel admin-section"></section>

            <!-- Withdrawal Requests Panel -->
            <section id="withdraw-requests-panel" class="admin-panel admin-section"></section>

            <!-- User Management Panel -->
            <section id="user-management-panel" class="admin-panel admin-section"></section>
            
            <!-- User List Panel -->
            <section id="user-list-panel" class="admin-panel admin-section"></section>

            <!-- NEW: Gift Code Panel -->
            <section id="gift-code-panel" class="admin-panel admin-section"></section>

            <!-- Game Controls Panel -->
            <section id="game-controls-panel" class="admin-panel admin-section"></section>

            <!-- Promotion Banner Panel -->
            <section id="promotion-panel" class="admin-panel admin-section">
                <h3>Promotion Management</h3>
                
                <!-- Form to add a new banner -->
                <div class="admin-panel" style="background-color: var(--bg-primary);">
                    <h4>Add New Banner</h4>
                    <div class="input-group">
                        <label for="new_promo_banner_url">New Banner Image URL</label>
                        <input type="text" id="new_promo_banner_url" placeholder="https://example.com/new-banner.jpg">
                    </div>
                    <div class="input-group">
                        <label for="new_promo_link_url">New Target Link URL</label>
                        <input type="text" id="new_promo_link_url" placeholder="https://your-promotion-link.com">
                    </div>
                    <button class="btn btn-green" id="create_promo_banner_btn" style="width: 100%;">Create New Banner</button>
                    <p class="admin-status" id="promo_create_status"></p>
                </div>

                <div class="divider"></div>

                <!-- Container for existing banners -->
                <h4>Existing Banners</h4>
                <p class="admin-status" id="promo_list_status">Loading banners...</p>
                <div id="promo_banners_list">
                    <!-- Banners will be dynamically inserted here by JavaScript -->
                </div>
            </section>
            
            <button id="logout-btn" class="btn">Logout</button>
        </div>
    </main>
</div>
<script>
    // --- TEMPLATE INJECTION (to keep the file clean) ---
    document.getElementById('dashboard-panel').innerHTML = `<h3>Dashboard Overview</h3><div class="stats-grid"><div class="stat-card"><h4>Total Users</h4><p id="total-users-stat">0</p></div><div class="stat-card"><h4>Total Balance (All Users)</h4><p>₹<span id="total-balance-stat">0.00</span></p></div><div class="stat-card"><h4>Pending Deposits</h4><p id="pending-deposits-stat">0</p></div><div class="stat-card"><h4>Pending Withdrawals</h4><p id="pending-withdrawals-stat">0</p></div></div>`;
    document.getElementById('deposit-requests-panel').innerHTML = `<h3>Pending Deposit Requests</h3><div class="table-container"><table><thead><tr><th>Date</th><th>User Email</th><th>Amount (₹)</th><th>UTR</th><th>Actions</th></tr></thead><tbody id="deposit_requests_tbody"></tbody></table></div><p class="admin-status" id="deposit_requests_status">Loading requests...</p>`;
    document.getElementById('withdraw-requests-panel').innerHTML = `<h3>Pending Withdrawal Requests</h3><div class="table-container"><table><thead><tr><th>Date</th><th>User Email</th><th>Amount (₹)</th><th>UPI ID</th><th>Actions</th></tr></thead><tbody id="withdraw_requests_tbody"></tbody></table></div><p class="admin-status" id="withdraw_requests_status">Loading requests...</p>`;
    document.getElementById('user-management-panel').innerHTML = `<h3>User Fund & Status Management</h3><label style="text-align:center; display:block; margin-bottom: 5px;">Add Funds</label><div class="admin-control"><input type="email" id="fund_userEmail" placeholder="User Email"><input type="number" id="fund_amount" placeholder="Amount"><button class="btn btn-primary" id="fund_addBtn">Add</button></div><p class="admin-status" id="fund_addStatus"></p><div class="divider"></div><label style="text-align:center; display:block; margin-bottom: 5px;">Withdraw Funds</label><div class="admin-control"><input type="email" id="withdraw_userEmail" placeholder="User Email"><input type="number" id="withdraw_amount" placeholder="Amount"><button class="btn btn-yellow" id="fund_withdrawBtn">Withdraw</button></div><p class="admin-status" id="fund_withdrawStatus"></p><div class="divider"></div><label style="text-align:center; display:block; margin-bottom: 5px;">User Status Control</label><div class="admin-control"><input type="email" id="status_userEmail" placeholder="User Email"><button class="btn btn-green" id="user_unblockBtn">Unblock</button><button class="btn btn-red" id="user_blockBtn">Block</button></div><p class="admin-status" id="user_status_adminStatus"></p><div class="divider"></div><label style="text-align:center; display:block; margin-bottom: 5px;">Delete User Account (Permanent)</label><div class="admin-control"><input type="email" id="delete_userEmail" placeholder="User Email"><button class="btn btn-red" id="user_deleteBtn">Delete Account</button></div><p class="admin-status" id="user_deleteStatus"></p>`;
    document.getElementById('user-list-panel').innerHTML = `<h3>All Users List</h3><button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" id="show_all_users_btn">Show / Refresh All Users</button><div class="table-container"><table id="all_users_table"><thead><tr><th>Email</th><th>Password</th><th>Balance</th><th>Status</th><th>Actions</th></tr></thead><tbody id="all_users_tbody"></tbody></table></div><p class="admin-status" id="all_users_status"></p>`;
    
    // Game Controls Panel
    document.getElementById('game-controls-panel').innerHTML = `<h3>Game Controls</h3><div style="margin-bottom: 20px;"><h4>Color Trading Control</h4><div class="admin-control"><input type="number" id="ct_adminWinningNumber" placeholder="Winning Number (0-9)" min="0" max="9"><button class="btn btn-green" id="ct_setResultBtn">Set Result</button></div><p class="admin-status" id="ct_adminStatus"></p></div><div class="divider"></div><div style="margin-bottom: 20px;"><h4>Hotline (Slots) Control</h4><p style="font-size: 0.8em; color: var(--text-secondary); text-align: center; margin-top: -10px; margin-bottom: 10px;">Set the result for the next spin.</p><div class="admin-control" style="flex-wrap: wrap; gap: 15px;"><select id="hotline_reel1_symbol"><option value="lemon">Lemon (5x)</option><option value="cherry">Cherry (10x)</option><option value="diamond">Diamond (25x)</option><option value="seven">Seven (100x)</option></select><select id="hotline_reel2_symbol"><option value="lemon">Lemon (5x)</option><option value="cherry" selected>Cherry (10x)</option><option value="diamond">Diamond (25x)</option><option value="seven">Seven (100x)</option></select><select id="hotline_reel3_symbol"><option value="lemon">Lemon (5x)</option><option value="cherry">Cherry (10x)</option><option value="diamond">Diamond (25x)</option><option value="seven">Seven (100x)</option></select><button class="btn btn-green" id="hotline_setResultBtn" style="width: 100%; margin-top: 10px;">Set Hotline Result</button></div><p class="admin-status" id="hotline_adminStatus"></p></div><div class="divider"></div><div style="margin-bottom: 20px;"><h4>Balloon Control</h4><div class="admin-control"><input type="number" id="balloon_adminPopMultiplier" placeholder="Pop Multiplier (e.g., 3.5)" step="0.1" min="1.01"><button class="btn btn-green" id="balloon_setResultBtn">Set Pop</button></div><p class="admin-status" id="balloon_adminStatus"></p></div><div class="divider"></div><div style="margin-bottom: 20px;"><h4>Keno Control</h4><div class="admin-control"><input type="text" id="keno_admin_drawn_numbers" placeholder="10 drawn numbers (e.g., 5,12,21...)"><button class="btn btn-green" id="keno_setNumbersBtn">Set Numbers</button></div><p class="admin-status" id="keno_adminStatus"></p></div><div class="divider"></div><div style="margin-bottom: 20px;"><h4>Mines Control</h4><div class="admin-control"><input type="text" id="mines_admin_bomb_positions" placeholder="Bomb positions (e.g., 5,12,21)"><button class="btn btn-green" id="mines_setPositionsBtn">Set Positions</button></div><p class="admin-status" id="mines_adminStatus"></p></div>`;

    // NEW: Gift Code Panel
    document.getElementById('gift-code-panel').innerHTML = `
        <h3>Gift Code Management</h3>
        <div class="admin-panel" style="background-color: var(--bg-primary);">
            <h4>Create New Gift Code</h4>
            <div class="input-group">
                <label for="new_gift_code">Gift Code (leave blank to generate)</label>
                <div class="admin-control">
                    <input type="text" id="new_gift_code" placeholder="e.g., WELCOME100">
                    <button class="btn btn-yellow" id="generate_gift_code_btn" style="flex-shrink: 0;">Generate</button>
                </div>
            </div>
            <div class="input-group">
                <label for="new_gift_amount">Amount (₹)</label>
                <input type="number" id="new_gift_amount" placeholder="e.g., 50">
            </div>
            <div class="input-group">
                <label for="new_gift_max_uses">Max Uses</label>
                <input type="number" id="new_gift_max_uses" placeholder="e.g., 100">
            </div>
            <button class="btn btn-green" id="create_gift_code_btn" style="width: 100%;">Create Gift Code</button>
            <p class="admin-status" id="gift_code_create_status"></p>
        </div>
        <div class="divider"></div>
        <h4>Existing Gift Codes</h4>
        <div class="table-container">
            <table>
                <thead>
                    <tr><th>Code</th><th>Amount</th><th>Usage</th><th>Actions</th></tr>
                </thead>
                <tbody id="gift_codes_tbody"></tbody>
            </table>
        </div>
        <p class="admin-status" id="gift_code_list_status">Loading codes...</p>`;


    const firebaseConfig = {
      apiKey: "AIzaSyCbKl2KzC6_56e8KpHPNotSpPNRFn9nPck",
      authDomain: "colour-80089.firebaseapp.com",
      databaseURL: "https://colour-80089-default-rtdb.firebaseio.com",
      projectId: "colour-80089",
      storageBucket: "colour-80089.firebasestorage.app",
      messagingSenderId: "908917996461",
      appId: "1:908917996461:web:b3eeeb58cc75a3e250bf24",
      measurementId: "G-BQPPRYL7F3"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // DOM Elements
    const authContainer = document.getElementById('auth-container');
    const adminDashboard = document.getElementById('admin-dashboard');
    
    // Listener Flags
    let depositListenerActive = false;
    let withdrawListenerActive = false;
    let dashboardUsersListenerActive = false;
    let promotionListenerActive = false;
    let giftCodeListenerActive = false;


    // Auth Listeners
    auth.onAuthStateChanged(user => {
        if (user) {
            authContainer.style.display = 'none';
            adminDashboard.style.display = 'block';
            document.getElementById('admin-email').textContent = `${user.email}`;
            showSection('#dashboard-panel');
            initializeDashboard();
            initializeDepositWatcher();
            initializeWithdrawWatcher();
            initializeUserManagementPanel(); 
            initializePromotionPanel();
            initializeGiftCodePanel();
        } else {
            authContainer.style.display = 'block'; 
            adminDashboard.style.display = 'none';
            // Turn off all listeners on logout
            if(dashboardUsersListenerActive) { db.ref('users').off(); dashboardUsersListenerActive = false; }
            if(depositListenerActive) { db.ref('deposit_requests').off(); depositListenerActive = false; }
            if(withdrawListenerActive) { db.ref('withdraw_requests').off(); withdrawListenerActive = false; }
            if(promotionListenerActive) { db.ref('admin_controls/promotions').off(); promotionListenerActive = false; }
            if(giftCodeListenerActive) { db.ref('gift_codes').off(); giftCodeListenerActive = false; }
        }
    });
    
    // Sidebar and Section Toggling Logic
    function showSection(targetId) {
        document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('is-active'));
        const targetSection = document.querySelector(targetId);
        if (targetSection) {
            targetSection.classList.add('is-active');
        } else { 
            document.querySelector('#dashboard-panel').classList.add('is-active');
        }
    }

    document.getElementById('menu-toggle').addEventListener('click', () => {
        document.getElementById('menu-toggle').classList.toggle('active');
        document.getElementById('sidebar').classList.toggle('open');
    });

    document.querySelectorAll('.sidebar-link').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            if (link.id === 'logout-link-sidebar') { auth.signOut(); return; }
            showSection(link.getAttribute('data-target'));
            document.getElementById('menu-toggle').classList.remove('active');
            document.getElementById('sidebar').classList.remove('open');
        });
    });

    // Helper Functions
    async function findUserByEmail(email) {
        const usersRef = db.ref('users');
        const snapshot = await usersRef.orderByChild('email').equalTo(email).once('value');
        if (snapshot.exists()) {
            return Object.keys(snapshot.val())[0];
        }
        return null;
    }

    function createActionButton(text, className, onClick) {
        const btn = document.createElement('button');
        btn.textContent = text;
        btn.className = `btn action-btn ${className}`;
        btn.onclick = onClick;
        return btn;
    }

    function updateNotificationBadge(badgeId, count) {
        const badge = document.getElementById(badgeId);
        badge.textContent = count;
        badge.style.display = count > 0 ? 'inline-block' : 'none';

        if (badgeId === 'deposit-badge') { document.getElementById('pending-deposits-stat').textContent = count; } 
        else if (badgeId === 'withdraw-badge') { document.getElementById('pending-withdrawals-stat').textContent = count; }
    }

    function setStatusMessage(elementId, message, isError = false) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.style.color = isError ? 'var(--accent-red)' : 'var(--accent-green)';
        setTimeout(() => el.textContent = '', 4000);
    }
    
    // --- DASHBOARD ---
    function initializeDashboard() {
        if (dashboardUsersListenerActive) return;
        dashboardUsersListenerActive = true;
        db.ref('users').on('value', snapshot => {
            let userCount = 0, totalBalance = 0;
            if (snapshot.exists()) {
                userCount = snapshot.numChildren();
                snapshot.forEach(child => { totalBalance += child.val().balance || 0; });
            }
            document.getElementById('total-users-stat').textContent = userCount;
            document.getElementById('total-balance-stat').textContent = totalBalance.toLocaleString('en-IN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        });
    }
    
    // --- NEW: GIFT CODE PANEL ---
    function initializeGiftCodePanel() {
        if (giftCodeListenerActive) return;
        giftCodeListenerActive = true;

        // --- Create Code Logic ---
        document.getElementById('generate_gift_code_btn').addEventListener('click', () => {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 8; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            document.getElementById('new_gift_code').value = result;
        });

        document.getElementById('create_gift_code_btn').addEventListener('click', async () => {
            const codeInput = document.getElementById('new_gift_code');
            const amount = parseFloat(document.getElementById('new_gift_amount').value);
            const maxUses = parseInt(document.getElementById('new_gift_max_uses').value);
            const code = codeInput.value.trim().toUpperCase();

            if (!code || isNaN(amount) || isNaN(maxUses) || amount <= 0 || maxUses <= 0) {
                setStatusMessage('gift_code_create_status', 'Please fill all fields with valid numbers.', true);
                return;
            }

            const codeRef = db.ref('gift_codes/' + code);
            const snapshot = await codeRef.once('value');
            if (snapshot.exists()) {
                setStatusMessage('gift_code_create_status', 'This code already exists.', true);
                return;
            }

            const newCodeData = {
                amount: amount,
                max_uses: maxUses,
                times_used: 0,
                created_at: firebase.database.ServerValue.TIMESTAMP
            };

            await codeRef.set(newCodeData);
            setStatusMessage('gift_code_create_status', `Code "${code}" created successfully!`);
            codeInput.value = '';
            document.getElementById('new_gift_amount').value = '';
            document.getElementById('new_gift_max_uses').value = '';
        });

        // --- List Codes Logic ---
        db.ref('gift_codes').orderByChild('created_at').on('value', snapshot => {
            const tbody = document.getElementById('gift_codes_tbody');
            const statusEl = document.getElementById('gift_code_list_status');
            tbody.innerHTML = '';
            if (!snapshot.exists()) {
                statusEl.textContent = 'No gift codes found.';
                return;
            }
            statusEl.textContent = '';
            snapshot.forEach(child => {
                const code = child.key;
                const data = child.val();
                const row = tbody.insertRow(0); // Prepend new codes to the top
                row.insertCell(0).textContent = code;
                row.insertCell(1).textContent = `₹${data.amount.toFixed(2)}`;
                row.insertCell(2).textContent = `${data.times_used || 0} / ${data.max_uses}`;
                const actionCell = row.insertCell(3);
                actionCell.appendChild(createActionButton('Delete', 'btn-red', () => {
                    if (confirm(`Are you sure you want to delete the code "${code}"?`)) {
                        db.ref('gift_codes/' + code).remove();
                    }
                }));
            });
        });
    }


    // --- PROMOTION BANNER ---
    function initializePromotionPanel() {
        if (promotionListenerActive) return;
        promotionListenerActive = true;
        const createBtn = document.getElementById('create_promo_banner_btn');
        const newBannerUrlInput = document.getElementById('new_promo_banner_url');
        const newLinkUrlInput = document.getElementById('new_promo_link_url');
        createBtn.addEventListener('click', () => {
            const bannerUrl = newBannerUrlInput.value.trim();
            const linkUrl = newLinkUrlInput.value.trim();
            if (!bannerUrl || !linkUrl) { setStatusMessage('promo_create_status', 'Both banner and link URLs are required.', true); return; }
            db.ref('admin_controls/promotions').push({ bannerUrl, linkUrl })
                .then(() => { setStatusMessage('promo_create_status', 'New banner created successfully.'); newBannerUrlInput.value = ''; newLinkUrlInput.value = ''; })
                .catch(err => setStatusMessage('promo_create_status', `Error: ${err.message}`, true));
        });
        const listContainer = document.getElementById('promo_banners_list');
        const listStatusEl = document.getElementById('promo_list_status');
        const promotionsRef = db.ref('admin_controls/promotions');
        promotionsRef.on('value', snapshot => {
            listContainer.innerHTML = '';
            if (!snapshot.exists()) { listStatusEl.textContent = 'No promotion banners found. Create one above!'; return; }
            listStatusEl.textContent = '';
            snapshot.forEach(childSnapshot => { const bannerId = childSnapshot.key, bannerData = childSnapshot.val(); listContainer.prepend(createBannerCard(bannerId, bannerData)); });
        });
        function createBannerCard(bannerId, bannerData) { const card = document.createElement('div'); card.className = 'promo-card'; card.id = `promo-card-${bannerId}`; renderDefaultView(card, bannerId, bannerData); return card; }
        function renderDefaultView(card, bannerId, bannerData) {
            card.innerHTML = `<img src="${bannerData.bannerUrl}" alt="Banner Preview"><div class="info"><strong>Banner URL:</strong> <span>${bannerData.bannerUrl}</span></div><div class="info"><strong>Link URL:</strong> <span>${bannerData.linkUrl}</span></div><div class="actions"><button class="btn action-btn btn-yellow edit-btn">Edit</button><button class="btn action-btn btn-red delete-btn">Delete</button></div>`;
            card.querySelector('.delete-btn').addEventListener('click', () => { if (confirm('Are you sure?')) { promotionsRef.child(bannerId).remove().catch(err => alert(`Failed: ${err.message}`)); } });
            card.querySelector('.edit-btn').addEventListener('click', () => renderEditView(card, bannerId, bannerData));
        }
        function renderEditView(card, bannerId, bannerData) {
            card.innerHTML = `<div class="edit-inputs"><div class="input-group"><label>Banner Image URL</label><input type="text" class="edit-banner-url" value="${bannerData.bannerUrl}"></div><div class="input-group"><label>Target Link URL</label><input type="text" class="edit-link-url" value="${bannerData.linkUrl}"></div></div><div class="actions"><button class="btn action-btn btn-primary save-btn">Save</button><button class="btn action-btn cancel-btn">Cancel</button></div>`;
            card.querySelector('.save-btn').addEventListener('click', () => { const newBannerUrl = card.querySelector('.edit-banner-url').value.trim(); const newLinkUrl = card.querySelector('.edit-link-url').value.trim(); if (!newBannerUrl || !newLinkUrl) { alert('Both fields required.'); return; } promotionsRef.child(bannerId).update({ bannerUrl: newBannerUrl, linkUrl: newLinkUrl }).catch(err => alert(`Failed: ${err.message}`)); });
            card.querySelector('.cancel-btn').addEventListener('click', () => renderDefaultView(card, bannerId, bannerData));
        }
    }

    // --- DEPOSIT & WITHDRAW MANAGEMENT ---
    function initializeDepositWatcher() {
        if (depositListenerActive) return;
        depositListenerActive = true;
        db.ref('deposit_requests').on('value', snapshot => {
            const tbody = document.getElementById('deposit_requests_tbody');
            tbody.innerHTML = ''; let pendingCount = 0;
            if (!snapshot.exists()) { document.getElementById('deposit_requests_status').textContent = 'No deposit requests found.'; updateNotificationBadge('deposit-badge', 0); return; }
            snapshot.forEach(userSnapshot => {
                const userId = userSnapshot.key;
                userSnapshot.forEach(requestSnapshot => {
                    if (requestSnapshot.val().status === 'pending') {
                        pendingCount++; const req = requestSnapshot.val(), reqId = requestSnapshot.key; const row = tbody.insertRow(0);
                        row.insertCell(0).textContent = new Date(req.timestamp).toLocaleString(); row.insertCell(1).textContent = req.userEmail; row.insertCell(2).textContent = req.amount.toFixed(2); row.insertCell(3).textContent = req.utr;
                        const actionCell = row.insertCell(4);
                        actionCell.append(createActionButton('Approve', 'btn-green', () => handleDeposit(true, userId, reqId, req.amount, actionCell)), createActionButton('Reject', 'btn-red', () => handleDeposit(false, userId, reqId, 0, actionCell)));
                    }
                });
            });
            document.getElementById('deposit_requests_status').textContent = pendingCount > 0 ? '' : 'No pending deposit requests.';
            updateNotificationBadge('deposit-badge', pendingCount);
        });
    }

    function initializeWithdrawWatcher() {
        if (withdrawListenerActive) return;
        withdrawListenerActive = true;
        db.ref('withdraw_requests').on('value', snapshot => {
            const tbody = document.getElementById('withdraw_requests_tbody');
            tbody.innerHTML = ''; let pendingCount = 0;
            if (!snapshot.exists()) { document.getElementById('withdraw_requests_status').textContent = 'No withdrawal requests found.'; updateNotificationBadge('withdraw-badge', 0); return; }
            snapshot.forEach(userSnapshot => {
                const userId = userSnapshot.key;
                userSnapshot.forEach(requestSnapshot => {
                    if (requestSnapshot.val().status === 'pending') {
                        pendingCount++; const req = requestSnapshot.val(), reqId = requestSnapshot.key; const row = tbody.insertRow(0);
                        row.insertCell(0).textContent = new Date(req.timestamp).toLocaleString(); row.insertCell(1).textContent = req.userEmail; row.insertCell(2).textContent = req.amount.toFixed(2); row.insertCell(3).textContent = req.upiNumber;
                        const actionCell = row.insertCell(4);
                        actionCell.append(createActionButton('Approve', 'btn-green', () => handleWithdraw(true, userId, reqId, req.amount, actionCell)), createActionButton('Reject', 'btn-red', () => handleWithdraw(false, userId, reqId, req.amount, actionCell)));
                    }
                });
            });
            document.getElementById('withdraw_requests_status').textContent = pendingCount > 0 ? '' : 'No pending withdrawal requests.';
            updateNotificationBadge('withdraw-badge', pendingCount);
        });
    }

    async function handleDeposit(isApproved, userId, requestId, amount, actionCell) {
        actionCell.innerHTML = 'Processing...';
        try {
            if (isApproved) {
                await db.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) + amount);
                await db.ref(`users/${userId}/transactions`).push({ description: 'Deposit Approved', amount: amount, date: new Date().toLocaleTimeString(), timestamp: firebase.database.ServerValue.TIMESTAMP });
            }
            await db.ref(`deposit_requests/${userId}/${requestId}`).update({ status: isApproved ? 'approved' : 'rejected' });
        } catch (error) { actionCell.innerHTML = 'Error!'; }
    }
    
    async function handleWithdraw(isApproved, userId, requestId, amount, actionCell) {
        actionCell.innerHTML = 'Processing...';
        try {
            if (isApproved) {
                await db.ref(`users/${userId}/transactions`).push({ description: `Withdrawal of ₹${amount.toFixed(2)} Processed`, amount: 0, date: new Date().toLocaleTimeString(), timestamp: firebase.database.ServerValue.TIMESTAMP });
            } else { 
                await db.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) + amount);
                await db.ref(`users/${userId}/transactions`).push({ description: `Withdrawal Rejected (₹${amount.toFixed(2)}) - Refunded`, amount: amount, date: new Date().toLocaleTimeString(), timestamp: firebase.database.ServerValue.TIMESTAMP });
            }
            await db.ref(`withdraw_requests/${userId}/${requestId}`).update({ status: isApproved ? 'approved' : 'rejected' });
        } catch (error) { actionCell.innerHTML = 'Error!'; }
    }

    // --- USER MANAGEMENT PANEL LOGIC ---
    function initializeUserManagementPanel() {
        document.getElementById('fund_addBtn').addEventListener('click', async () => { const email = document.getElementById('fund_userEmail').value.trim(); const amount = parseFloat(document.getElementById('fund_amount').value); if (!email || isNaN(amount) || amount <= 0) { setStatusMessage('fund_addStatus', 'Invalid email or amount.', true); return; } const userId = await findUserByEmail(email); if (!userId) { setStatusMessage('fund_addStatus', 'User not found.', true); return; } await db.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) + amount); await db.ref(`users/${userId}/transactions`).push({ description: 'Admin Deposit', amount: amount, date: new Date().toLocaleTimeString(), timestamp: firebase.database.ServerValue.TIMESTAMP }); setStatusMessage('fund_addStatus', `Successfully added ₹${amount} to ${email}.`); document.getElementById('fund_userEmail').value = ''; document.getElementById('fund_amount').value = ''; });
        document.getElementById('fund_withdrawBtn').addEventListener('click', async () => { const email = document.getElementById('withdraw_userEmail').value.trim(); const amount = parseFloat(document.getElementById('withdraw_amount').value); if (!email || isNaN(amount) || amount <= 0) { setStatusMessage('fund_withdrawStatus', 'Invalid email or amount.', true); return; } const userId = await findUserByEmail(email); if (!userId) { setStatusMessage('fund_withdrawStatus', 'User not found.', true); return; } const { committed } = await db.ref(`users/${userId}/balance`).transaction(bal => (bal || 0) < amount ? undefined : bal - amount); if (committed) { await db.ref(`users/${userId}/transactions`).push({ description: 'Admin Withdrawal', amount: -amount, date: new Date().toLocaleTimeString(), timestamp: firebase.database.ServerValue.TIMESTAMP }); setStatusMessage('fund_withdrawStatus', `Successfully withdrew ₹${amount} from ${email}.`); document.getElementById('withdraw_userEmail').value = ''; document.getElementById('withdraw_amount').value = ''; } else { setStatusMessage('fund_withdrawStatus', 'Withdrawal failed: Insufficient funds.', true); } });
        const setUserBlockStatus = async (isBlocked) => { const email = document.getElementById('status_userEmail').value.trim(); if (!email) { setStatusMessage('user_status_adminStatus', 'Please enter an email.', true); return; } const userId = await findUserByEmail(email); if (!userId) { setStatusMessage('user_status_adminStatus', 'User not found.', true); return; } await db.ref(`users/${userId}`).update({ isBlocked: isBlocked }); setStatusMessage('user_status_adminStatus', `User ${email} has been ${isBlocked ? 'blocked' : 'unblocked'}.`); document.getElementById('status_userEmail').value = ''; };
        document.getElementById('user_unblockBtn').addEventListener('click', () => setUserBlockStatus(false));
        document.getElementById('user_blockBtn').addEventListener('click', () => setUserBlockStatus(true));
        document.getElementById('user_deleteBtn').addEventListener('click', async () => { const email = document.getElementById('delete_userEmail').value.trim(); if (!email) { setStatusMessage('user_deleteStatus', 'Please enter an email.', true); return; } if (!confirm(`Are you sure you want to PERMANENTLY DELETE user ${email}? This cannot be undone.`)) return; const userId = await findUserByEmail(email); if (!userId) { setStatusMessage('user_deleteStatus', 'User not found.', true); return; } await db.ref(`users/${userId}`).remove(); setStatusMessage('user_deleteStatus', `User ${email} and all data deleted.`); document.getElementById('delete_userEmail').value = ''; });
    }

    // --- USER LIST & GAME CONTROLS ---
    document.getElementById('show_all_users_btn').addEventListener('click', async () => {
        const statusEl = document.getElementById('all_users_status');
        const tbody = document.getElementById('all_users_tbody');
        statusEl.textContent = 'Loading users...'; tbody.innerHTML = '';
        const snapshot = await db.ref('users').once('value');
        if (!snapshot.exists()) { statusEl.textContent = 'No users found.'; return; }
        snapshot.forEach(child => {
            const uid = child.key, user = child.val(), isBlocked = user.isBlocked === true;
            const row = tbody.insertRow();
            row.insertCell(0).textContent = user.email || 'N/A';
            row.insertCell(1).textContent = user.password || 'N/A'; // Assumes password is saved in DB
            row.insertCell(2).textContent = (user.balance || 0).toFixed(2);
            const statusCell = row.insertCell(3); statusCell.textContent = isBlocked ? 'Blocked' : 'Active'; statusCell.className = isBlocked ? 'status-blocked' : 'status-active';
            const actionCell = row.insertCell(4);
            const toggleBtn = createActionButton(isBlocked ? 'Unblock' : 'Block', isBlocked ? 'btn-green' : 'btn-red', async () => { toggleBtn.textContent = '...'; toggleBtn.disabled = true; await db.ref(`users/${uid}`).update({ isBlocked: !isBlocked }); document.getElementById('show_all_users_btn').click(); });
            actionCell.appendChild(toggleBtn);
        });
        statusEl.textContent = 'User list loaded.';
    });

    function setAdminControl(game, key, value, statusEl) {
        db.ref(`admin_controls/${game}/${key}`).set(value)
            .then(() => setStatusMessage(statusEl, `Success! ${game} result set.`))
            .catch(error => setStatusMessage(statusEl, `Error: ${error.message}`, true));
    }
    
    // Game Control Listeners
    document.getElementById('ct_setResultBtn').addEventListener('click', () => { const val = parseInt(document.getElementById('ct_adminWinningNumber').value); if (!isNaN(val) && val >= 0 && val <= 9) { setAdminControl('color_trading', 'next_result', val, 'ct_adminStatus'); } else { alert('Enter 0-9.'); } });
    document.getElementById('mines_setPositionsBtn').addEventListener('click', () => { const val = document.getElementById('mines_admin_bomb_positions').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n)); if (val.length > 0 && val.length <= 20) { setAdminControl('mines', 'next_positions', val, 'mines_adminStatus'); } else { alert('Enter 1-20 comma-separated positions.'); } });
    
    document.getElementById('hotline_setResultBtn').addEventListener('click', () => {
        const result = [document.getElementById('hotline_reel1_symbol').value, document.getElementById('hotline_reel2_symbol').value, document.getElementById('hotline_reel3_symbol').value];
        setAdminControl('hotline', 'next_result', result, 'hotline_adminStatus');
    });
    
    document.getElementById('balloon_setResultBtn').addEventListener('click', () => {
        const val = parseFloat(document.getElementById('balloon_adminPopMultiplier').value);
        if (!isNaN(val) && val > 1) { setAdminControl('balloon', 'next_pop_multiplier', val, 'balloon_adminStatus'); } 
        else { alert('Enter a valid pop multiplier greater than 1.0.'); }
    });

    document.getElementById('keno_setNumbersBtn').addEventListener('click', () => {
        const val = document.getElementById('keno_admin_drawn_numbers').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n) && n >= 1 && n <= 40);
        const uniqueVal = [...new Set(val)];
        if (uniqueVal.length === 10) { setAdminControl('keno', 'next_drawn_numbers', uniqueVal, 'keno_adminStatus'); } 
        else { alert('Enter exactly 10 unique, comma-separated numbers between 1 and 40.'); }
    });

    // Auth UI and Actions
    const loginBox = document.getElementById('login-box'), signupBox = document.getElementById('signup-box');
    document.getElementById('show-signup').addEventListener('click', () => { loginBox.style.display = 'none'; signupBox.style.display = 'block'; });
    document.getElementById('show-login').addEventListener('click', () => { signupBox.style.display = 'none'; loginBox.style.display = 'block'; });
    document.getElementById('signup-btn').addEventListener('click', () => { const e = document.getElementById('signup-email').value, p = document.getElementById('signup-password').value, c = document.getElementById('signup-confirm-password').value, err = document.getElementById('signup-error'); err.textContent = ''; if (p !== c) { err.textContent = 'Passwords do not match.'; return; } auth.createUserWithEmailAndPassword(e, p).then(() => { alert('Sign up successful!'); loginBox.style.display = 'block'; signupBox.style.display = 'none'; }).catch(e => err.textContent = e.message); });
    document.getElementById('login-btn').addEventListener('click', () => { const e = document.getElementById('login-email').value, p = document.getElementById('login-password').value, err = document.getElementById('login-error'); err.textContent = ''; auth.signInWithEmailAndPassword(e, p).catch(e => err.textContent = e.message); });
    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());
</script>

</body>
</html>